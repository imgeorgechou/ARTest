<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <title>AR 追蹤</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r17/Stats.min.js"></script>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline'; worker-src * blob:;"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <style>
      body {
        margin: 0;
      }
      .example-container {
        overflow: hidden;
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #error-message {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 9999;
        text-align: center;
        max-width: 80%;
      }
      .show-error {
        display: block !important;
      }

      /* 添加 footer 樣式 */
      .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        text-align: center;
        padding: 15px 0;
        font-size: 16px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div class="example-container">
      <div id="error-message"></div>
      <!-- 添加初始提示框 -->
      <div
        id="initial-message"
        style="
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          z-index: 9999;
          text-align: center;
          max-width: 80%;
        "
      >
        第一次開啟AR相機，會載入較久，請耐心等待
      </div>

      <a-scene
        mindar-image="imageTargetSrc: ./targets.mind;"
        embedded
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
      >
        <a-assets>
          <img id="ans1-img" src="./ans1.png" />
          <img id="ans2-img" src="./ans2.png" />
          <img id="ans5-img" src="./ans5.png" />
          <img id="ans6-img" src="./ans6.png" />
          <img id="ans7-img" src="./ans7.png" />
          <img id="ans8-img" src="./ans8.png" />
          <img id="ans9-img" src="./ans9.png" />
          <img id="ans10-img" src="./ans10.png" />
          <img id="ans11-img" src="./ans11.png" />
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- 第一個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 0">
          <a-entity id="target0-content" position="0 0 0" rotation="0 0 0">
            <!-- 使用自定義 geometry 避免變形 -->
            <a-plane
              material="shader: flat; src: #ans1-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans1-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第二個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 1">
          <a-entity id="target1-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans2-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans2-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第三個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 2">
          <a-entity id="target2-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans5-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans5-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第四個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 3">
          <a-entity id="target3-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans6-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans6-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第五個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 4">
          <a-entity id="target4-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans7-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans7-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第六個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 5">
          <a-entity id="target5-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans8-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans8-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第七個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 6">
          <a-entity id="target6-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans9-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans9-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第八個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 7">
          <a-entity id="target7-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans10-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans10-img"
            ></a-plane>
          </a-entity>
        </a-entity>

        <!-- 第九個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 8">
          <a-entity id="target8-content" position="0 0 0" rotation="0 0 0">
            <a-plane
              material="shader: flat; src: #ans11-img; transparent: true; alphaTest: 0.5"
              geometry="primitive: plane; width: auto; height: auto;"
              scale="1 1 1"
              position="0 0 0"
              class="ar-image"
              data-image-id="ans11-img"
            ></a-plane>
          </a-entity>
        </a-entity>
      </a-scene>

      <!-- 添加 footer -->
      <div class="footer">掃描完畢後，請點擊上一頁回到遊戲</div>
    </div>

    <script>
      // 添加性能監控
      const stats = new Stats();
      stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
      document.body.appendChild(stats.dom);

      // 確保圖片保持原始比例的函數
      function adjustImageAspectRatios() {
        // 獲取所有具有 data-image-id 屬性的 a-plane 元素
        const arImages = document.querySelectorAll(".ar-image");

        arImages.forEach((arImage) => {
          const imageId = arImage.getAttribute("data-image-id");
          if (!imageId) return;

          const imgElement = document.getElementById(imageId);
          if (!imgElement) return;

          // 確保圖片已經加載完成
          if (imgElement.complete) {
            applyAspectRatio(arImage, imgElement);
          } else {
            imgElement.onload = () => {
              applyAspectRatio(arImage, imgElement);
            };
          }
        });
      }

      // 應用寬高比例到 a-plane 元素
      function applyAspectRatio(arPlane, imgElement) {
        const width = imgElement.naturalWidth;
        const height = imgElement.naturalHeight;
        const aspectRatio = width / height;

        // 保持寬高比例，根據較大的尺寸來決定縮放因子
        let scaleX, scaleY;

        // 強制保持原始比例
        scaleX = aspectRatio;
        scaleY = 1;

        // 應用縮放
        arPlane.setAttribute("width", 1); // 基準寬度
        arPlane.setAttribute("height", 1); // 基準高度
        arPlane.setAttribute("scale", `${scaleX} ${scaleY} 1`);

        console.log(
          `調整圖片 ${imgElement.id} 比例: ${aspectRatio}, 寬度: ${width}, 高度: ${height}, 縮放: ${scaleX} x ${scaleY}`
        );
      }

      window.addEventListener("load", async () => {
        // 顯示初始提示
        const initialMessage = document.getElementById("initial-message");
        initialMessage.style.display = "block";

        // 5秒後自動隱藏提示
        setTimeout(() => {
          initialMessage.style.display = "none";
        }, 5000);

        try {
          const sceneEl = document.querySelector("a-scene");

          // 等待場景載入
          await new Promise((resolve) => {
            if (sceneEl.hasLoaded) {
              resolve();
            } else {
              sceneEl.addEventListener("loaded", resolve, { once: true });
            }
          });

          // 調整圖片比例
          adjustImageAspectRatios();

          // 檢查相機權限
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
              },
            });

            // 釋放相機
            stream.getTracks().forEach((track) => track.stop());

            // 獲取 AR 系統
            const arSystem = sceneEl.systems["mindar-image-system"];
            if (!arSystem) {
              throw new Error("AR 系統未能初始化");
            }

            // 目標找到時觸發
            sceneEl.addEventListener("targetFound", (event) => {
              const targetIndex = event.detail.targetIndex;
              console.log("目標找到:", targetIndex);

              // 顯示找到目標的提示
              showMessage(`找到目標 ${targetIndex + 1}`);
            });

            sceneEl.addEventListener("targetLost", (event) => {
              const targetIndex = event.detail.targetIndex;
              console.log("目標遺失:", event.detail.targetIndex);

              // 顯示失去目標的提示
              showMessage(`失去目標 ${targetIndex + 1}`);
            });

            // 添加初始化完成事件
            sceneEl.addEventListener("arReady", () => {
              console.log("AR 系統準備就緒");
              showMessage("系統準備就緒，請掃描目標圖片");

              // AR 系統準備完成後再次確認比例
              adjustImageAspectRatios();
            });

            // 監聽錯誤
            sceneEl.addEventListener("arError", (event) => {
              console.error("AR錯誤:", event.detail);
              showError("AR 系統錯誤: " + (event.detail.message || "未知錯誤"));
            });

            // 修改性能監控代碼
            function animate() {
              stats.begin();

              // 檢查 FPS
              const fps = stats.getFPS && stats.getFPS();
              if (fps && fps < 24) {
                console.warn("性能警告: FPS低於24");
              }

              stats.end();
              requestAnimationFrame(animate);
            }
            animate();

            // 啟動 AR
            await arSystem.start();
            console.log("AR 系統啟動成功");

            // AR 啟動後再次確認比例
            setTimeout(adjustImageAspectRatios, 1000);
          } catch (err) {
            console.error("相機或 AR 初始化錯誤:", err);
            showError(err.message || "相機初始化失敗");
          }
        } catch (error) {
          console.error("系統錯誤:", error);
          showError(error.message || "系統初始化失敗");
        }
      });

      // 添加訊息顯示函數
      function showMessage(message) {
        const messageElement = document.createElement("div");
        messageElement.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 10px 20px;
          border-radius: 5px;
          z-index: 1000;
        `;
        messageElement.textContent = message;
        document.body.appendChild(messageElement);

        setTimeout(() => {
          messageElement.remove();
        }, 3000);
      }

      function showError(message) {
        const errorElement = document.getElementById("error-message");
        errorElement.textContent = message;
        errorElement.style.display = "block";
        setTimeout(() => {
          errorElement.style.display = "none";
        }, 5000);
      }

      // 監聽視窗調整大小，重新調整比例
      window.addEventListener("resize", adjustImageAspectRatios);

      // 添加一個MutationObserver來確保圖片比例在DOM變化時保持
      const observer = new MutationObserver(() => {
        adjustImageAspectRatios();
      });

      // 開始觀察場景變化
      observer.observe(document.querySelector("a-scene"), {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ["visible", "scale", "position"],
      });
    </script>
  </body>
</html>
