<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <title>AR 追蹤</title>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #my-ar-container {
        position: absolute;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="my-ar-container">
      <a-scene
        mindar-image="imageTargetSrc: targets.mind; 
                          autoStart: true; 
                          uiScanning: true; 
                          uiLoading: true;"
        embedded
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
      >
        <a-assets>
          <img id="target-image-1" src="ans1.png" />
          <img id="target-image-2" src="ans2.png" />
          <img id="target-image-3" src="ans3.png" />
          <img id="target-image-4" src="ans4.png" />
          <img id="target-image-5" src="ans5.png" />
          <img id="target-image-6" src="ans6.png" />
          <img id="target-image-7" src="ans7.png" />
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- 第一個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 0">
          <a-plane
            src="#target-image-1"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第二個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 1">
          <a-plane
            src="#target-image-2"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第三個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 2">
          <a-plane
            src="#target-image-3"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
        <!-- 第四個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 3">
          <a-plane
            src="#target-image-4"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
        <!-- 第五個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 4">
          <a-plane
            src="#target-image-5"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
        <!-- 第六個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 5">
          <a-plane
            src="#target-image-6"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
        <!-- 第七個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 6">
          <a-plane
            src="#target-image-7"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
      </a-scene>
    </div>

    <script>
      // 強制直式螢幕
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock("portrait").catch((error) => {
          console.log("無法鎖定螢幕方向:", error);
        });
      }

      // 偵測錯誤
      document.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector("a-scene");
        scene.addEventListener("error", (event) => {
          console.error("場景載入錯誤:", event);
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const sceneEl = document.querySelector("a-scene");
        const arSystem = sceneEl.systems["mindar-image-system"];

        // 檢查瀏覽器相容性
        console.log("UserAgent:", navigator.userAgent);
        console.log(
          "支援 getUserMedia:",
          !!navigator.mediaDevices?.getUserMedia
        );

        // 檢查資源載入
        console.log(
          "targets.mind 路徑:",
          document.querySelector("a-scene").getAttribute("mindar-image")
            .imageTargetSrc
        );

        const checkResources = async () => {
          try {
            const mindARPath = document
              .querySelector("a-scene")
              .getAttribute("mindar-image").imageTargetSrc;
            const response = await fetch(mindARPath);
            if (!response.ok) {
              throw new Error(
                `無法載入 targets.mind (狀態: ${response.status})`
              );
            }
            console.log("targets.mind 載入成功");

            const images = document.querySelectorAll("img");
            const imagePromises = Array.from(images).map((img) => {
              return new Promise((resolve, reject) => {
                if (img.complete) {
                  resolve(img);
                } else {
                  img.onload = () => resolve(img);
                  img.onerror = () =>
                    reject(new Error(`圖片 ${img.id} 載入失敗`));
                }
              });
            });

            await Promise.all(imagePromises);
            console.log("所有圖片載入成功");
          } catch (err) {
            console.error("資源載入錯誤:", err);
            alert("資源載入失敗，請重新整理頁面");
          }
        };

        // 修改相機權限檢查
        const checkCameraPermission = async () => {
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(
              (device) => device.kind === "videoinput"
            );
            console.log("可用相機數量:", cameras.length);

            const result = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment", // 強制使用後置相機
              },
            });
            console.log("相機權限已獲得");
            return true;
          } catch (err) {
            console.error("相機權限錯誤:", err);
            if (err.name === "NotAllowedError") {
              alert("請允許使用相機權限！可能需要重新整理頁面。");
            } else if (err.name === "NotFoundError") {
              alert("找不到相機設備，請確認相機可用。");
            } else {
              alert("相機初始化失敗：" + err.message);
            }
            return false;
          }
        };

        // 初始化檢查
        (async () => {
          await checkCameraPermission();
          await checkResources();
        })();

        // 監聽目標檢測事件
        sceneEl.addEventListener("targetFound", (event) => {
          console.log("目標找到了！索引:", event.detail.targetIndex);
        });

        sceneEl.addEventListener("targetLost", (event) => {
          console.log("目標丟失了！索引:", event.detail.targetIndex);
        });

        // 監聽初始化完成事件
        sceneEl.addEventListener("arReady", (event) => {
          console.log("AR 系統準備就緒");
        });

        // 監聽錯誤事件
        sceneEl.addEventListener("arError", (event) => {
          console.error("AR 系統發生錯誤:", event);
          alert("AR 系統發生錯誤，請重新載入頁面");
        });

        // 監聽載入完成事件
        arSystem.addEventListener("loaded", (event) => {
          console.log("Mind AR 已載入完成");
        });

        // 監聽相機初始化
        sceneEl.addEventListener("camera-init", (event) => {
          console.log("相機初始化成功");
        });

        sceneEl.addEventListener("camera-error", (event) => {
          console.error("相機初始化失敗:", event);
          alert("相機初始化失敗，請確認相機權限並重新載入");
        });
      });
    </script>
  </body>
</html>
