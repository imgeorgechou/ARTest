<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <title>AR 追蹤</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script>
      // 等待 A-Frame 載入完成
      AFRAME.registerComponent("mind-ar-loader", {
        init: function () {
          // 動態載入 MindAR 腳本
          const mindARScript = document.createElement("script");
          mindARScript.src =
            "https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js";
          mindARScript.onload = () => {
            const aframeScript = document.createElement("script");
            aframeScript.src =
              "https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js";
            aframeScript.onload = () => {
              // 腳本載入完成後觸發事件
              this.el.emit("mindar-loaded");
            };
            document.head.appendChild(aframeScript);
          };
          document.head.appendChild(mindARScript);
        },
      });
    </script>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline'; worker-src * blob:;"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #my-ar-container {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #error-message {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 9999;
        text-align: center;
        max-width: 80%;
      }
      .show-error {
        display: block !important;
      }
      .ar-container {
        position: absolute;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <!-- 添加導航 -->
    <div
      id="nav-buttons"
      style="position: fixed; top: 10px; right: 10px; z-index: 1000"
    >
      <button
        onclick="switchGroup(1)"
        style="background: #fff; padding: 8px; margin: 5px; border-radius: 5px"
      >
        組別 1
      </button>
      <button
        onclick="switchGroup(2)"
        style="background: #fff; padding: 8px; margin: 5px; border-radius: 5px"
      >
        組別 2
      </button>
    </div>

    <!-- 第一組 AR 場景 -->
    <div id="ar-group-1" class="ar-container">
      <a-scene
        mind-ar-loader
        mindar-image="imageTargetSrc: ./targets-group1.mind;"
        embedded
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
      >
        <a-assets>
          <img id="target-image-1" src="./ans1.png" />
          <img id="target-image-2" src="./ans2.png" />
          <img id="target-image-3" src="./ans3.png" />
          <img id="target-image-4" src="./ans4.png" />
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- 第一個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 0">
          <a-plane
            src="#target-image-1"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第二個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 1">
          <a-plane
            src="#target-image-2"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第三個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 2">
          <a-plane
            src="#target-image-3"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第四個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 3">
          <a-plane
            src="#target-image-4"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
      </a-scene>
    </div>

    <!-- 第二組 AR 場景 -->
    <div id="ar-group-2" class="ar-container" style="display: none">
      <a-scene
        mind-ar-loader
        mindar-image="imageTargetSrc: ./targets-group2.mind;"
        embedded
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
      >
        <a-assets>
          <img id="target-image-5" src="./ans5.png" />
          <img id="target-image-6" src="./ans6.png" />
          <img id="target-image-7" src="./ans7.png" />
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- 第五個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 4">
          <a-plane
            src="#target-image-5"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第六個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 5">
          <a-plane
            src="#target-image-6"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>

        <!-- 第七個辨識目標 -->
        <a-entity mindar-image-target="targetIndex: 6">
          <a-plane
            src="#target-image-7"
            position="0 0 0"
            height="1"
            width="1"
            rotation="0 0 0"
          >
          </a-plane>
        </a-entity>
      </a-scene>
    </div>

    <div id="my-ar-container">
      <div
        id="error-message"
        style="
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          z-index: 9999;
        "
      ></div>
    </div>

    <script>
      let currentGroup = 1;
      let activeSystem = null;

      async function switchGroup(groupNum) {
        if (currentGroup === groupNum) return;

        // 停止當前的 AR 系統
        if (activeSystem) {
          await activeSystem.stop();
        }

        // 隱藏當前組別，顯示新組別
        document.getElementById(`ar-group-${currentGroup}`).style.display =
          "none";
        document.getElementById(`ar-group-${groupNum}`).style.display = "block";

        // 初始化新的 AR 系統
        const newScene = document.querySelector(
          `#ar-group-${groupNum} a-scene`
        );
        activeSystem = newScene.systems["mindar-image-system"];
        await activeSystem.start();

        currentGroup = groupNum;
      }

      // 初始化第一組
      window.addEventListener("load", async () => {
        const scene1 = document.querySelector("#ar-group-1 a-scene");
        activeSystem = scene1.systems["mindar-image-system"];
        await activeSystem.start();
      });

      // 強制直式螢幕
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock("portrait").catch((error) => {
          console.log("無法鎖定螢幕方向:", error);
        });
      }

      // 偵測錯誤
      document.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector("a-scene");
        scene.addEventListener("error", (event) => {
          console.error("場景載入錯誤:", event);
        });
      });

      // 添加錯誤顯示函數
      function showError(message) {
        const errorElement = document.getElementById("error-message");
        errorElement.textContent = message;
        errorElement.classList.add("show-error");

        // 同時在控制台輸出
        console.error(message);

        // 5秒後自動隱藏
        setTimeout(() => {
          errorElement.classList.remove("show-error");
        }, 5000);
      }

      // 修改初始化邏輯
      window.addEventListener("load", async () => {
        try {
          const sceneEl = document.querySelector("a-scene");

          // 添加性能監控
          const startTime = performance.now();

          // 等待 MindAR 完全載入
          await new Promise((resolve) => {
            if (window.MINDAR && window.MINDAR.IMAGE) {
              resolve();
            } else {
              sceneEl.addEventListener("mindar-loaded", resolve, {
                once: true,
              });
            }
          });

          console.log("MindAR 載入時間:", performance.now() - startTime, "ms");

          // 獲取 AR 系統
          const arSystem = sceneEl.systems["mindar-image-system"];
          if (!arSystem) {
            throw new Error("AR 系統未能初始化");
          }

          // 設置性能相關參數
          if (arSystem.controller) {
            arSystem.controller.warmupTolerance = 5;
            arSystem.controller.missTolerance = 5;
          }

          // 啟動 AR
          await arSystem.start();
          console.log("AR 系統啟動成功");
          console.log("總初始化時間:", performance.now() - startTime, "ms");
        } catch (error) {
          console.error("系統錯誤:", error);
          showError(error.message || "系統初始化失敗");
        }
      });
    </script>
  </body>
</html>
